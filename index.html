<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>CutthRun</title>
	<style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
		@font-face {
			font-family: 'pixel';
			src: url("./assets/BoutiqueBitmap9x9_1.9.ttf");/* 像素字体 */
		}
        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
			/* font-family: 'pixel',sans-serif !important; */
			font-family: 'pixel';
			font-size: 16px;
        }
    </style>
	<script src="./assets/phaser.min.js"></script>
</head>
<body>
	<div id="game-container"></div>
	<script>
	onload=function(){
		var style = {
			font: 'pixel', // 在@font-face中声明的字体名称
			fontSize: '24px',
			fill: '#ffffff'
		};

		var time_start_count = 0;
		var bootState = function(game){
			this.preload=function(){
				game.load.image('loading','assets/preloader.gif');
			};
			this.create=function(){
				game.state.start('loader');
			};
		}

		var loaderState=function(game){
			var progressText;
			this.init=function(){
				var sprite=game.add.image(game.world.centerX,game.world.centerY,'loading');
				sprite.anchor={x:0.5,y:0.5};
				progressText=game.add.text(game.world.centerX,game.world.centerY+30,'0%',style);
				progressText.anchor={x:0.5,y:0.5};
			};
			this.preload=function(){
				game.load.image('background','assets/background.jpg');//标题背景
				game.load.image('help','assets/help.png');
				game.load.image('area','assets/area.jpg');//游戏背景
				game.load.image('title','assets/CutthRun.png');//标题
				game.load.image('myScore','assets/myScore.png');
				game.load.image('line1','assets/line1.png');
				game.load.image('line2','assets/line2.png');
				game.load.spritesheet('button',"assets/button.png",272,80);
				game.load.image('block','assets/block.png');//障碍物
				game.load.spritesheet('player',"assets/Cutth.png",32,40);//每隔32/40切割精灵
				game.load.spritesheet('wu',"assets/wu.png",123.5,100);
				game.load.onFileComplete.add(function(progress){
					progressText.text=progress+'%';
				});
			};
			this.create=function(){
				if (progressText.text=="100%") {
					game.state.start('welcome');
				}
			};
		}

//------------------------------开始界面------------------------------
		var welcomeState = function(game){
			this.create=function(){
				game.add.image(0,0,"background");
				var title = game.add.image(0,0,"title");

				title.scale.setTo(.5);
				title.x = game.world.centerX - title.width/2;

				game.add.sprite(0,0,"line1").y = title.y + title.height;
				game.add.sprite(0,0,"line1").y = game.world.height - title.height;
				
				var btnStart = game.add.image(0,0,"button");
				btnStart.scale.setTo(.6);
				btnStart.x = game.world.centerX - btnStart.width/2;
				btnStart.y = title.height * 2;

				if (document.fonts.check('16px "pixel"')) { // 检查字体是否已经可用
					// 创建并显示包含自定义字体的文本
					var textStart = game.add.text(0,0,"开始游戏",style);
					textStart.font = 'pixel';
					textStart.x = btnStart.x + (btnStart.width - textStart.width)/2;
					textStart.y = btnStart.y + (btnStart.height - textStart.height)/2;
					// 其他欢迎界面元素的创建...
				} else {
					// 若字体未加载完成，设置一个定时器稍后尝试
					setTimeout(function() {
					this.create(); // 再次调用create方法以检查字体是否加载成功
					}.bind(this), 100); // 延迟500毫秒
				}

				var btnHelp = game.add.image(0,0,"button");
				btnHelp.scale.setTo(.6);
				btnHelp.x = game.world.centerX - btnStart.width/2;
				btnHelp.y = title.height * 3.125;
				var textHelp = game.add.text(0,0,"游戏说明",style);
				textHelp.font = 'pixel';
				//textHelp.fill = "white"
				textHelp.x = btnHelp.x + (btnHelp.width - textHelp.width)/2;
				textHelp.y = btnHelp.y + (btnHelp.height - textHelp.height)/2;
				btnStart.inputEnabled = true;
				btnStart.events.onInputDown.addOnce(Down,this);
				btnHelp.inputEnabled = true;
				btnHelp.events.onInputDown.add(function(){
					var help = game.add.image(0,0,"help");
					var title = game.add.image(0,0,"title");
					title.scale.setTo(.5);
					title.x = game.world.centerX - title.width/2;
					game.add.sprite(0,0,"line1").y = title.y + title.height;
					var l2 = game.add.sprite(0,0,"line1").y = game.world.height - title.height;
					var btnBack = game.add.image(0,0,"button");
					btnBack.frame = 1;
					btnBack.scale.setTo(.6);
					btnBack.x = game.world.centerX - btnBack.width/2;
					btnBack.y = l2 - btnBack.height - 10;
					var textBack = game.add.text(0,0,"返回",style);
					textBack.font = 'pixel';
					textBack.x = btnBack.x + (btnBack.width - textBack.width)/2;
					textBack.y = btnBack.y + (btnBack.height - textBack.height)/2;
					btnBack.inputEnabled = true;
					btnBack.events.onInputDown.addOnce(function(){
						help.destroy();
						btnBack.destroy();
					});
				},this);
			};
		}
		
//------------------------------结束界面------------------------------		
		var gameoverState = function(game){
			var score = 0;
			var topScore=0;
			this.create=function(){
				game.add.image(0,0,"background");
				var title = game.add.image(0,0,"myScore");
				title.x = game.world.centerX - title.width/2;
				game.add.sprite(0,0,"line1").y = title.y + title.height;
				var l2 = game.add.sprite(0,0,"line1").y = game.world.height - title.height;
				
				//返回按钮
				var btnBack = game.add.image(0,0,"button");
				btnBack.frame = 1;
				btnBack.scale.setTo(.4,.5);
				btnBack.x = game.world.centerX /1.5;
				btnBack.y = l2 + btnBack.height /2;
				var textBack = game.add.text(0,0,"返回",style);
				textBack.font = 'pixel';
				textBack.x = btnBack.x + (btnBack.width - textBack.width)/2;
				textBack.y = btnBack.y + (btnBack.height - textBack.height)/2;

				//最高得分
				var topScore = localStorage.getItem("topScore")==null?0:localStorage.getItem("topScore");
				score = localStorage.getItem("score")==null?0:localStorage.getItem("score");
				var textScore = game.add.text(0,0,"本局 " + score + "秒");
				textScore.font = 'pixel';
				textScore.x = game.world.centerX - textScore.width/2;
				textScore.y = title.height * 2;
				var textTopScore = game.add.text(0,0,"最佳 " + topScore + "秒");
				textTopScore.font = 'pixel';
				textTopScore.x = game.world.centerX - textTopScore.width/2;
				textTopScore.y = title.height * 3;

				btnBack.inputEnabled = true;
				btnBack.events.onInputDown.addOnce(function(){game.state.start("boot")});
			};
		}
////////////////////////////////////////////////////////////////////////////////////////
		var gameState = function(game){
			var textTimer;
			var timer = 0;
			var ground1;
			var ground2;
			var player1;
			var player2;
			var block1_width=0;
			var block1_height=0;
			var block1;
			var block2;
			var score = 0;
			var topScore=0;
			this.create=function(){
				topScore = localStorage.getItem("topScore")==null?0:localStorage.getItem("topScore");
				game.physics.startSystem(Phaser.Physics.ARCADE);						//开启物理引擎
				time_start_count = game.time.totalElapsedSeconds().toFixed(3);			//游戏之前的时间统计
				document.title = time_start_count;
				var area_up = game.add.image(0,0,"area");								//取分上下两个区域
				var area_down = game.add.image(0,area_up.height,"area");

				area_up.inputEnabled = true;											//鼠标在两个区域内分别按下事件
				area_down.inputEnabled = true;
				area_up.events.onInputDown.add(function(){
					document.title = 'player1.jump'
					player1.body.velocity.y = -200;
				});

				//实时显示游戏运行时间
				timer = game.time.totalElapsedSeconds().toFixed(3) - time_start_count;	//计算游戏运行时间
				textTimer = game.add.text(0,0,timer+"\"");
				textTimer.x = game.width - textTimer.width;

				ground1 = game.add.sprite(0,0,"line2");									//两个地板条
				game.physics.arcade.enable(ground1);
				ground1.body.immovable = true;
				ground1.y = game.world.centerY - ground1.height;

				player1 = game.add.sprite(-3,0,"player");								//两个跑男
				game.physics.arcade.enable(player1);
				player1.body.gravity.y = 400;//重力
				player1.animations.add('move', [0, 1, 2, 3], 10, true);//按精灵表播放动画帧，每s播放10帧，循环true

				// block1 = game.add.group();												//路障方块
				// block1.enableBody = true;
				//注释掉的部分 以组的形式产生路障 用于多个路障
				// var block = block1.create(0,0,"block");
				// block1_width = block1.width;
				// block1_height = block1.height;
				// block.width = game.rnd.between(block.width/5,block.width);
				// block.height = game.rnd.between(block.height/10,block.height);
				// block.y = ground1.y - block.height;
				// block.x = game.rnd.between(game.world.centerX,game.world.width);

				block1 = game.add.sprite(0,0,"block");
				game.physics.arcade.enable(block1);
				block1_width = block1.width;
				block1_height = block1.height;
				block1.width = game.rnd.between(block1.width/5,block1.width);
				block1.height = game.rnd.between(block1.height/10,block1.height);
				block1.y = ground1.y - block1.height;
				block1.x = game.rnd.between(game.world.centerX,game.world.width);

			};
			this.update=function(){
				//当玩家碰到障碍物时的处理
				game.physics.arcade.collide(player1, ground1);
				//game.physics.arcade.collide(player2, ground2);
				game.physics.arcade.collide(player1, block1,function(){
					score = timer.toFixed(3);
					localStorage.setItem("topScore",Math.max(score,topScore));//储存比较最高分
					localStorage.setItem("score",score);
					game.state.start("gameover");
				});

				player1.animations.play('move');

				textTimer.text = "";
				timer = game.time.totalElapsedSeconds().toFixed(3) - time_start_count;
				textTimer = game.add.text(0,0,timer.toFixed(3)+"\"");
				textTimer.font = 'pixel';
				textTimer.x = game.width - textTimer.width;

				block1.x-=2;
				if (block1.x < 0) {
					block1.width = game.rnd.between(block1_width/5,block1_width);
					block1.height = game.rnd.between(block1_height/10,block1_height);
					block1.x = game.world.width;
					block1.y = ground1.y - block1.height;
				}

			}
		}
////////////////////////////////////////////////////////////////////////////////////////
		function Down(){
			game.state.start('main');
		}

		// var game=new Phaser.Game(320,480,Phaser.CANVAS);//游戏窗口大小
		// game.state.add('boot',bootState);
		// game.state.add('loader',loaderState);
		// game.state.add('welcome',welcomeState);
		// game.state.add('main',gameState);
		// game.state.add('gameover',gameoverState);
		// game.state.start('boot');

		var gameContainer = document.getElementById('game-container');

            // 为游戏容器添加自适应大小并居中
            var scaleOptions = {
                width: window.innerWidth,
                height: window.innerHeight,
                parent: gameContainer,
            };

            var game = new Phaser.Game(320, 480, Phaser.CANVAS, 'game-container', null, false, false, scaleOptions);



            // 添加游戏状态
            game.state.add('boot', bootState);
            game.state.add('loader', loaderState);
            game.state.add('welcome', welcomeState);
            game.state.add('main', gameState);
            game.state.add('gameover', gameoverState);

            // 启动游戏
            game.state.start('boot');

            // 监听窗口大小改变并更新游戏大小
            window.addEventListener('resize', function () {
                game.resize(scaleOptions.width, scaleOptions.height);
            });

	}
	</script>
</body>
</html>
